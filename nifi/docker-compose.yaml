services:

  nifi:
    build:
      context: .
      dockerfile: Dockerfile
    image: custom-nifi:2.4.0
    container_name: nifi
    ports:
      - "8080:8080"
    volumes:
      - nifi_data:/opt/nifi/nifi-current/data
    profiles:
      - nifi
      - all

  nifi-registry:
    image: apache/nifi-registry:2.4.0
    container_name: nifi-registry
    ports:
      - "18080:18080"
    environment:
      - NIFI_REGISTRY_WEB_HTTP_PORT=18080
    volumes:
      - registry_data:/opt/nifi-registry/nifi-registry-current/data
    profiles:
      - registry
      - all
      - nifi

  kafka:
    image: bitnami/kafka:latest
    container_name: kafka
    ports:
      - '9094:9094'
    environment:
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_CONTROLLER_BROKER_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
    volumes:
      - kafka_data:/bitnami/kafka
    profiles:
      - kafka
      - all

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8081:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    depends_on:
      - kafka
    profiles:
      - kafka
      - all

  hdfs-namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: hdfs-namenode
    environment:
      - CLUSTER_NAME=test-hadoop-cluster
      - HDFS_CONF_dfs_permissions=false
    ports:
      - "9870:9870"
    volumes:
      - namenode_data:/hadoop/dfs/name
    profiles:
      - hdfs
      - all

  hdfs-datanode:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: hdfs-datanode
    environment:
      - CLUSTER_NAME=test-hadoop-cluster
      - CORE_CONF_fs_defaultFS=hdfs://hdfs-namenode:8020
    depends_on:
      - hdfs-namenode
    ports:
      - "9864:9864"
    volumes:
      - datanode_data:/hadoop/dfs/data
    profiles:
      - hdfs
      - all

  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=testdb
      - MYSQL_USER=testuser
      - MYSQL_PASSWORD=testpass
    volumes:
      - mysql_data:/var/lib/mysql
    profiles:
      - mysql
      - all

volumes:
  nifi_data:
  registry_data:
  kafka_data:
  namenode_data:
  datanode_data:
  mysql_data: